<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href = "style.css">
</head>

<h1> <b> Welcome to the Stock Tool</b></h1>
<br/>
<input list="search tool" id="search bar">
<datalist name ="searh" id="search tool">
</datalist>
<br/>

<button id="go" > enter  </button>

<select name="Time Period" id="Time Period Input">
    <option value="1y">1 Year</option>
    <option value="ytd">Year-to-Date</option>
    <option value="1m">1 Month</option>
    <option value="3m">3 Months</option>
    <option value="6m">6 Months</option>
    <option value="2y">2 Years</option>
    <option value="5y">5 Years</option>
    <option value="1d">1 Day </option>
</select>

<body>

<div class="stock_container">
    <p id="symbol">  </p>
    <p id="company">  </p>
    <p id="sector"> </p>
    <p id = "date"> </p>
    <p id="open_price" > </p>
    <p id="close_price"> </p>
    <p id="high">  </p>
    <p id="low">  </p>
    <p id = "ptoe">  </p>
    <p id = "icon"> </p>
 </div>

<div id="myDiv"></div>
</body>

<script>//search tool
var searchBar= document.getElementById("search bar");
var searchlist = document.getElementById("search tool");
removeOptions(searchlist);
searchBar.addEventListener("keyup", function(){
  var key = "32QMUO3CUW1PD4LI";
  var current_input = searchBar.value;
  var url = "https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=" + current_input + " &apikey=" + key;
  if(current_input != "") {
      try {
          $.getJSON(url, function (data) {
              var str = '';
              for (i = 0; i < 4; i++) {
                  var name = data['bestMatches'][i]['2. name'];
                  var symb = data['bestMatches'][i]['1. symbol'];
                  str += '<option value="' + symb + '" >' + name + '</option>';
              }
              searchlist.innerHTML = str;
          })
      }
      catch (e) {
            console.log("Access Denied from API")
      }

  }
});
//  var newOption = document.createElement("option");
//   newOption.value = data['bestMatches'][i]['1. symbol'];
//     newOption.innerHTML = data['bestMatches'][i]['2. name'];
function removeOptions(selectbox)
{
  var i;
  for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
  {
    selectbox.remove(i);
  }
}


</script>

<script>
  $("#go").click(function () {
        var myArray = [];
        var x_arr=[];
    var stockName = document.getElementById("search bar").value;
    var selectmenu = document.getElementById("Time Period Input");
    var datalength = selectmenu.options[selectmenu.selectedIndex].value;

    var url = "https://api.iextrading.com/1.0/stock/" +stockName + "/batch?types=quote,news,chart,stats,financials,earnings&range="+datalength;
    var fiveYrfinances ="https://api.iextrading.com/1.0/stock/" + stockName+ "/financials?period=annual";
    console.log(fiveYrfinances);
        try {
            $.getJSON(url, function (data) {//gets JSON from the API server
                //if(data=="ERROR") {alert("pls enter a valid stock name" ;}
                var symbol = stockName;
                console.log(data);
                var lastRefreshed = data['quote']['latestTime'];
                var lastTradePrice = data['quote']['close'];
                var OpenTrade = data['quote']['open'];
                var company = data['quote']['companyName'];
                var high = data['quote']['week52High'];
                var low = data['quote']['week52Low'];
                var pToE = data['quote']['peRatio'];
                var sector = data['quote']['sector'];
                var finance = financial_ratios(data['financials']['financials']);
                $.getJSON(fiveYrfinances, function (annualdata) {
                    var longTermfinance = financial_ratios(annualdata['financials']);
                    document.getElementById("5yrRev").innerHTML = "5 Year Rev. Growth: " + longTermfinance[3];        //$(".date").append(lastRefreshed);

                });

                var retArr = chart_to_array(data, datalength);
                var divYield = stats(data['stats']);
                myArray = retArr[0];
                x_arr = retArr[1];
                document.getElementById("date").innerHTML = "Most Recent Date" + lastRefreshed;        //$(".date").append(lastRefreshed);
                document.getElementById('open_price').innerHTML= "Open Price: " + OpenTrade;
                document.getElementById('close_price').innerHTML= "Close Price: " + lastTradePrice;
                document.getElementById("symbol").innerHTML = "Symbol: " + symbol;
                document.getElementById('company').innerHTML= "Company: " + company;
                document.getElementById("sector").innerHTML = "Sector: " + sector;
                document.getElementById("high").innerHTML = "52 Week High: " + high;
                document.getElementById('low').innerHTML= "52 Week Low: " + low;
                document.getElementById("ptoe").innerHTML = "ptoe: " + pToE;

             var PeGs = earnings_growth(data['earnings'], pToE);


                plot_graph(x_arr, myArray, symbol);

                document.getElementById('1yrRev').innerHTML= "1 Year Rev. Growth: " + finance[3];
                document.getElementById('GrossMarg').innerHTML= "Gross Margin: " + finance[0];
                document.getElementById("NetMarg").innerHTML = "Net Margin: " + finance[1];
                document.getElementById('DebtToEquity').innerHTML= "Debt To Equity: " + finance[2];
                document.getElementById("CurrentRatio").innerHTML = "Current Ratio: " ;
                document.getElementById("ReturnOnE").innerHTML = "Return on Equity: " ;
                document.getElementById('NormalizedPe').innerHTML= "Normalized P/E: " ;
                document.getElementById("CurrentYield").innerHTML = "Current Yield: " + divYield;
                document.getElementById("DivGrowth").innerHTML = "Dividend Growth: " + div_growth(stockName) ;
                document.getElementById("ptoEgrowth").innerHTML = "P/E Growth: " + PeGs.toFixed(2);


            })
        }
        catch (e) {
            alert("Please enter a valid Stock Ticker");
        }

  });


function plot_graph(x_arr, y_arr, ticker) {
  var trace1 = {
    x: x_arr,
    y: y_arr,
    type: 'scatter',
  };

  var layout = {
    title: ticker.toUpperCase() + " Closing Prices"
  };

  var graph = [trace1];

  Plotly.newPlot('myDiv', graph, layout);

}


function chart_to_array(data,desired_length){
  var datapts=0;
  var x_coord=[];
  var y_coord=[];
  if(desired_length==="1d"){
      for(i in data["chart"]){
          x_coord.push(data["chart"][i]["label"]);
          y_coord.push(data["chart"][i]["close"]);
      }

  }
else {
      for (i in data["chart"]) {
          x_coord.push(data["chart"][i]["date"]);
          y_coord.push(data["chart"][i]["close"]);
      }
  }
    return([
    y_coord,
    x_coord

  ])
  ;
}

function earnings_growth(data, pE){//function to calculate the Earnings growth over the given period
      var year1 = [];
      var year2 =[];
      var growth=0;
      for(i=0; i<4; i++){
          year1.push(data['earnings'][i]['actualEPS']);
          year2.push(data['earnings'][i]['yearAgo']);
      }
        egr = year1.concat(year2);
      console.log(egr.toString());
      var pegs= [];

    for(x = 1;x<egr.length;x++) {
           pegs.push(((((egr[x-1]/egr[x])-1)*100)));
    }


    for(i=0; i<pegs.length; i++){
            pegs[i]= (pE/pegs[i]);
            growth+=pegs[i];
        }
        growth= growth/pegs.length;
        return growth;
}

function financial_ratios(data){
     // for(i in data) {
    let i =0;
        console.log(data);
          var grossMargin = (data[i]['grossProfit'] / data[i]['totalRevenue']);
          var netMargin = (data[i]['netIncome'] / data[i]['totalRevenue']);
          var debtToEquity = (data[i]['totalLiabilities'] / data[i]['shareholderEquity']);
          var revGrowth =((data[i]['totalRevenue']-data[data.length-1]['totalRevenue'])/(data[data.length-1]['totalRevenue']))*100;
      //}

      return ([
          grossMargin,
          netMargin,
          debtToEquity,
          revGrowth
      ]);



  }

function stats(data) {
      return([
          data['dividendYield'],
      ])
}

function div_growth(name) {
    console.log(name);
    var gRowth;
    var url = "https://api.iextrading.com/1.0/stock/" + name +  "/dividends/5y";
    $.getJSON(url, function (data){
        for(i in data){
            var l = i++;
            gRowth +=(((data[i]['amount'])-(data[l]['amount']))/(data[l]['amount']));
            console.log(gRowth);
            if(i === data.length-1){
                break;
            }
        }
        console.log(data.length);
        console.log(gRowth);


        if(data.length != 0){
            gRowth= gRowth/data.length-1;
        }
        return gRowth;

    })


}

</script>

<div class="Important Info">
    <p id="5yrRev">  </p>
    <p id="1yrRev">  </p>
    <p id="GrossMarg"> </p>
    <p id = "NetMarg"> </p>
    <p id="DebtToEquity" > </p>
    <p id="CurrentRatio"> </p>
    <p id="ReturnOnE">  </p>
    <p id="NormalizedPe">  </p>
    <p id = "CurrentYield">  </p>
    <p id = "DivGrowth"> </p>
</div>
<div class="interesting">
    <p id="ptoEgrowth">  </p>
</div>



</html>